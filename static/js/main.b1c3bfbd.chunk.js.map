{"version":3,"sources":["App.js","index.js"],"names":["modelPromise","tf","vocabularyPromise","fetch","then","response","json","tokenizerPromise","Promise","resolve","kuromoji","builder","dicPath","build","_","tokenizer","inference","words","a","model","vocabulary","layers","getWeights","transpose","array","weight","map","word","tokenize","text","basic_form","filter","countWords","count","Object","entries","dimensionalityReduction","inputData","TSNE","dim","perplexity","earlyExaggeration","learningRate","nIter","metric","init","data","type","run","getOutputScaled","clustering","numClusters","skmeans","idxs","improveLayout","d3","force","strength","radius","r","iterations","tick","stop","visualize","console","time","timeEnd","wordVector","xy","groups","rScale","domain","range","forEach","i","x","x0","y","y0","group","optimalFontSize","fontFamily","fontWeight","document","createElementNS","textContent","setAttributeNS","svg","appendChild","body","ok","ng","iter","m","getBBox","width","height","Math","sqrt","removeChild","Chart","margin","scale","contentSize","max","abs","min","color","className","viewBox","transform","key","fill","fontSize","textAnchor","dominantBaseline","App","useState","setWords","onSubmit","event","preventDefault","target","elements","value","name","defaultValue","render","getElementById"],"mappings":"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","file":"static/js/main.b1c3bfbd.chunk.js","sourcesContent":["import React, { useState } from \"react\";\nimport kuromoji from \"kuromoji\";\nimport * as tf from \"@tensorflow/tfjs\";\nimport TSNE from \"tsne-js\";\nimport skmeans from \"skmeans\";\nimport * as d3 from \"d3\";\n\nconst modelPromise = tf.loadLayersModel(\"word2vec/model.json\");\nconst vocabularyPromise = fetch(\"vocabulary.json\").then((response) =>\n  response.json(),\n);\nconst tokenizerPromise = new Promise((resolve) => {\n  kuromoji.builder({ dicPath: \"dict\" }).build((_, tokenizer) => {\n    resolve(tokenizer);\n  });\n});\n\nconst inference = async (words) => {\n  const model = await modelPromise;\n  const vocabulary = await vocabularyPromise;\n  const weight = await model.layers[3].getWeights()[0].transpose().array();\n  return words.map(({ word }) => weight[vocabulary[word]]);\n};\n\nconst tokenize = async (text) => {\n  const tokenizer = await tokenizerPromise;\n  const vocabulary = await vocabularyPromise;\n  return tokenizer\n    .tokenize(text)\n    .map(({ basic_form }) => basic_form)\n    .filter((word) => word in vocabulary);\n};\n\nconst countWords = (words) => {\n  const count = {};\n  for (const word of words) {\n    if (!(word in count)) {\n      count[word] = 0;\n    }\n    count[word] += 1;\n  }\n  return Object.entries(count).map(([word, count]) => ({ word, count }));\n};\n\nconst dimensionalityReduction = (inputData) => {\n  const model = new TSNE({\n    dim: 2,\n    perplexity: 30.0,\n    earlyExaggeration: 4.0,\n    learningRate: 100.0,\n    nIter: 200,\n    metric: \"euclidean\",\n  });\n  model.init({\n    data: inputData,\n    type: \"dense\",\n  });\n  model.run();\n  return model.getOutputScaled();\n};\n\nconst clustering = (inputData, numClusters) => {\n  return skmeans(inputData, numClusters).idxs;\n};\n\nconst improveLayout = (words) => {\n  const simulation = d3\n    .forceSimulation(words)\n    .force(\"charge\", d3.forceManyBody().strength(10))\n    .force(\n      \"collide\",\n      d3\n        .forceCollide()\n        .radius(({ r }) => r + 1)\n        .iterations(30),\n    )\n    .force(\"x\", d3.forceX(0))\n    .force(\"y\", d3.forceY(0));\n  simulation.tick(100).stop();\n};\n\nconst visualize = async (text, numClusters) => {\n  console.time(\"preprocess\");\n  const words = countWords(await tokenize(text));\n  console.timeEnd(\"preprocess\");\n  console.time(\"inference\");\n  const wordVector = await inference(words);\n  console.timeEnd(\"inference\");\n  console.time(\"dimensionalityReduction\");\n  const xy = dimensionalityReduction(wordVector);\n  console.timeEnd(\"dimensionalityReduction\");\n  console.time(\"clustering\");\n  const groups = clustering(xy, numClusters);\n  console.timeEnd(\"clustering\");\n\n  const rScale = d3\n    .scaleSqrt()\n    .domain(d3.extent(words, ({ count }) => count))\n    .range([10, 30]);\n  words.forEach((word, i) => {\n    word.x = word.x0 = xy[i][0] * 600;\n    word.y = word.y0 = xy[i][1] * 600;\n    word.group = groups[i];\n    word.r = rScale(word.count);\n  });\n  console.time(\"improveLayout\");\n  improveLayout(words);\n  console.timeEnd(\"improveLayout\");\n  return words;\n};\n\nconst optimalFontSize = (word, r, fontFamily, fontWeight) => {\n  const text = document.createElementNS(\"http://www.w3.org/2000/svg\", \"text\");\n  text.textContent = word;\n  text.setAttributeNS(null, \"font-family\", fontFamily);\n  text.setAttributeNS(null, \"font-weight\", fontWeight);\n  const svg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\n  svg.appendChild(text);\n  document.body.appendChild(svg);\n  let ok = 0;\n  let ng = 100;\n  for (let iter = 0; iter < 10; ++iter) {\n    let m = (ok + ng) / 2;\n    text.setAttributeNS(null, \"font-size\", m);\n    const { width, height } = text.getBBox();\n    const d = Math.sqrt(width ** 2 + height ** 2) / 2;\n    if (d <= r) {\n      ok = m;\n    } else {\n      ng = m;\n    }\n  }\n  document.body.removeChild(svg);\n  return ok;\n};\n\nconst Chart = ({ words }) => {\n  const contentSize = 600;\n  const margin = {\n    top: 10,\n    right: 10,\n    bottom: 10,\n    left: 10,\n  };\n  const width = contentSize + margin.left + margin.right;\n  const height = contentSize + margin.top + margin.bottom;\n  const fontFamily = `'Sawarabi Gothic', sans-serif`;\n  const fontWeight = \"normal\";\n\n  const scale =\n    contentSize /\n    2 /\n    Math.max(\n      ...[\n        Math.abs(Math.min(...words.map(({ x, r }) => x - r))),\n        Math.abs(Math.max(...words.map(({ x, r }) => x + r))),\n        Math.abs(Math.min(...words.map(({ y, r }) => y - r))),\n        Math.abs(Math.max(...words.map(({ y, r }) => y + r))),\n      ],\n    );\n  const color = d3.scaleOrdinal(d3.schemeCategory10);\n\n  return (\n    <svg className=\"chart\" viewBox={`0 0 ${width} ${height}`}>\n      <g transform={`translate(${margin.left},${margin.top})`}>\n        <g transform={`translate(${contentSize / 2},${contentSize / 2})`}>\n          {words.map((word) => {\n            return (\n              <g\n                key={word.word}\n                transform={`translate(${word.x * scale},${\n                  word.y * scale\n                })scale(${scale})`}\n              >\n                <circle r={word.r} fill={color(word.group)} />\n                <text\n                  fill=\"ghostwhite\"\n                  fontSize={optimalFontSize(word.word, word.r)}\n                  fontFamily={fontFamily}\n                  fontWeight={fontWeight}\n                  textAnchor=\"middle\"\n                  dominantBaseline=\"central\"\n                >\n                  {word.word}\n                </text>\n              </g>\n            );\n          })}\n        </g>\n      </g>\n    </svg>\n  );\n};\n\nexport const App = () => {\n  const [words, setWords] = useState([]);\n\n  return (\n    <div>\n      <section className=\"hero is-dark\">\n        <div className=\"hero-body\">\n          <div className=\"container\">\n            <h1 className=\"title\">Semantic Preserving Word Bubbles</h1>\n            <h2 className=\"subtitle\">\n              As an Alternative to WordClouds for Text Visualization\n            </h2>\n          </div>\n        </div>\n      </section>\n      <section className=\"section\">\n        <div className=\"container\">\n          <form\n            onSubmit={async (event) => {\n              event.preventDefault();\n              const text = event.target.elements.text.value;\n              const numClusters = +event.target.elements.numClusters.value;\n              setWords(await visualize(text, numClusters));\n            }}\n          >\n            <div className=\"field\">\n              <label className=\"label\">Input Text</label>\n              <div className=\"control\">\n                <textarea name=\"text\" className=\"textarea\" />\n              </div>\n            </div>\n            <div className=\"field\">\n              <label className=\"label\">Number of Clusters</label>\n              <div className=\"control\">\n                <input\n                  name=\"numClusters\"\n                  type=\"number\"\n                  min=\"0\"\n                  max=\"10\"\n                  defaultValue=\"5\"\n                  className=\"input\"\n                />\n              </div>\n            </div>\n            <div className=\"field\">\n              <div className=\"control\">\n                <button className=\"button is-dark\" type=\"submit\">\n                  Visualize\n                </button>\n              </div>\n            </div>\n          </form>\n        </div>\n      </section>\n      <section className=\"section\">\n        <div className=\"container\">\n          <Chart words={words} />\n        </div>\n      </section>\n      <footer className=\"footer\">\n        <div className=\"content has-text-centered\">\n          <p>&copy; 2020 Yosuke Onoue</p>\n        </div>\n      </footer>\n    </div>\n  );\n};\n","import \"bulma/css/bulma.css\";\nimport \"./index.css\";\n\nimport React from \"react\";\nimport { render } from \"react-dom\";\nimport { App } from \"./App\";\n\nrender(<App />, document.getElementById(\"content\"));\n"],"sourceRoot":""}